<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üß† AI Productivity Coach</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --light-primary: #6366f1; 
            --light-secondary: #8b5cf6; 
            --light-accent: #10b981;
            --light-background: #f8fafc; 
            --light-card: #ffffff; 
            --light-text: #1e293b; 
            --light-text-secondary: #64748b; 
            --light-border: #e2e8f0; 
            --light-danger: #ef4444;
            
            --dark-primary: #818cf8; 
            --dark-secondary: #a78bfa; 
            --dark-accent: #34d399;
            --dark-background: #0f172a; 
            --dark-card: #1e293b; 
            --dark-text: #f1f5f9; 
            --dark-text-secondary: #94a3b8; 
            --dark-border: #334155; 
            --dark-danger: #f87171;
        }

        [data-theme="light"] { 
            --primary-color: var(--light-primary); 
            --secondary-color: var(--light-secondary); 
            --accent-color: var(--light-accent);
            --background-color: var(--light-background); 
            --card-background: var(--light-card); 
            --text-color: var(--light-text); 
            --text-secondary-color: var(--light-text-secondary); 
            --border-color: var(--light-border); 
            --danger-color: var(--light-danger);
        }

        [data-theme="dark"] { 
            --primary-color: var(--dark-primary); 
            --secondary-color: var(--dark-secondary); 
            --accent-color: var(--dark-accent);
            --background-color: var(--dark-background); 
            --card-background: var(--dark-card); 
            --text-color: var(--dark-text); 
            --text-secondary-color: var(--dark-text-secondary); 
            --border-color: var(--dark-border); 
            --danger-color: var(--dark-danger);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            font-family: 'Kanit', sans-serif; 
            background: var(--background-color); 
            color: var(--text-color); 
            min-height: 100vh; 
            padding: 0;
            padding-bottom: 80px;
            font-size: 18px;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s; 
        }

        body.in-focus-mode .container { 
            filter: blur(5px); 
            transform: scale(0.98); 
            pointer-events: none; 
        }

        .container { 
            max-width: 650px; 
            margin: 0 auto;
            padding: 16px;
            transition: all 0.4s ease; 
        }

        /* ========== HEADER ========== */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px;
            padding: 12px 0;
        }

        header h1 { 
            font-weight: 700; 
            color: var(--primary-color); 
            font-size: 24px;
        }

        .theme-switch-wrapper { 
            display: flex; 
            align-items: center; 
        } 

        .theme-switch { 
            display: inline-block; 
            height: 32px; 
            position: relative; 
            width: 60px; 
        } 

        .theme-switch input { 
            display: none; 
        } 

        .slider { 
            background-color: #cbd5e1; 
            bottom: 0; 
            cursor: pointer; 
            left: 0; 
            position: absolute; 
            right: 0; 
            top: 0; 
            transition: .3s; 
            border-radius: 34px; 
        } 

        .slider:before { 
            background-color: white; 
            bottom: 4px; 
            content: ""; 
            height: 24px; 
            left: 4px; 
            position: absolute; 
            transition: .3s; 
            width: 24px; 
            border-radius: 50%; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        } 

        input:checked + .slider { 
            background-color: var(--primary-color); 
        } 

        input:checked + .slider:before { 
            transform: translateX(28px); 
        }

        /* ========== AI RECOMMENDATION CARD ========== */
        #ai-recommendation-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            color: white;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            display: none;
            animation: slideDown 0.4s ease-out;
        }

        #ai-recommendation-card.visible {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .ai-icon {
            font-size: 32px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .ai-label {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-task-name {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .ai-reason {
            font-size: 14px;
            opacity: 0.85;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .ai-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .ai-btn {
            padding: 14px 16px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Kanit', sans-serif;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-height: 70px;
        }

        .ai-btn:active {
            transform: scale(0.95);
        }

        .ai-btn.primary {
            background: rgba(255,255,255,0.95);
            color: var(--primary-color);
            border-color: transparent;
        }

        .ai-btn-icon {
            font-size: 24px;
        }

        .ai-btn-text {
            font-size: 13px;
        }

        /* ========== INPUT AREA ========== */
        .input-area { 
            display: flex; 
            margin-bottom: 20px;
            gap: 8px;
        }

        #task-input { 
            flex-grow: 1; 
            min-width: 0; 
            padding: 16px 18px; 
            border: 2px solid var(--border-color); 
            background: var(--card-background); 
            color: var(--text-color); 
            border-radius: 14px; 
            font-size: 16px; 
            font-family: 'Kanit', sans-serif;
            transition: all 0.3s; 
        }

        #task-input:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary-color) 15%, transparent); 
        }

        #add-task-btn { 
            padding: 16px 24px; 
            border: none; 
            background: var(--primary-color); 
            color: white; 
            border-radius: 14px; 
            cursor: pointer; 
            font-size: 18px; 
            font-weight: 600; 
            font-family: 'Kanit', sans-serif;
            transition: all 0.2s; 
            white-space: nowrap;
            min-height: 56px;
        }

        #add-task-btn:active { 
            transform: scale(0.95);
        }

        /* ========== CONTROLS ========== */
        .controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            gap: 12px;
            background: var(--card-background);
            padding: 8px;
            border-radius: 14px;
            border: 1px solid var(--border-color);
        }

        .filters { 
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .filters button { 
            background: transparent;
            border: none; 
            color: var(--text-secondary-color); 
            cursor: pointer; 
            font-size: 15px; 
            padding: 10px 16px; 
            transition: all 0.2s; 
            border-radius: 10px;
            font-family: 'Kanit', sans-serif;
            font-weight: 500;
            min-height: 44px;
        }

        .filters button.active { 
            color: white;
            background: var(--primary-color);
        }

        #clear-completed-btn { 
            background: none; 
            border: none; 
            color: var(--danger-color); 
            cursor: pointer; 
            font-size: 14px; 
            font-family: 'Kanit', sans-serif;
            font-weight: 500;
            padding: 10px 12px;
            min-height: 44px;
            display: none; 
        }

        #clear-completed-btn.visible { 
            display: inline; 
        }

        /* ========== TASK LIST ========== */
        #task-list { 
            list-style-type: none; 
        }

        .task-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 18px; 
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            margin-bottom: 12px;
            user-select: none;
            transition: all 0.2s;
        }

        .task-item:active {
            transform: scale(0.98);
        }

        .task-item.done {
            opacity: 0.6;
        }

        .task-item.done .task-text { 
            text-decoration: line-through; 
            color: var(--text-secondary-color); 
        }

        .mood-character { 
            font-size: 28px; 
            display: inline-block;
            min-width: 32px;
        }

        @keyframes bounce { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-6px); } 
        }

        .mood-character.excited { 
            animation: bounce 0.6s infinite alternate ease-in-out; 
        }

        @keyframes yawn { 
            0%, 100% { transform: translateY(0); opacity: 1; } 
            50% { transform: translateY(2px); opacity: 0.7; } 
        }

        .mood-character.sleepy { 
            animation: yawn 2.5s infinite alternate ease-in-out; 
        }

        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--accent-color);
        }

        .task-content { 
            flex-grow: 1; 
            min-width: 0; 
        }

        .task-text { 
            font-size: 17px; 
            word-break: break-word;
            font-weight: 500;
            display: block;
            margin-bottom: 6px;
        }

        .task-details { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            flex-wrap: wrap; 
        }

        .task-timestamp { 
            font-size: 13px; 
            color: var(--text-secondary-color); 
        }

        .task-countdown { 
            font-size: 13px; 
            color: var(--accent-color); 
            font-weight: 600; 
        }

        .priority-tag { 
            font-size: 11px; 
            font-weight: 600; 
            padding: 4px 10px; 
            border-radius: 12px; 
            background-color: #fee2e2; 
            color: #dc2626; 
        }

        [data-theme="dark"] .priority-tag { 
            background-color: #7f1d1d; 
            color: #fecaca; 
        }

        .task-actions { 
            display: flex; 
            align-items: center;
            gap: 8px;
        }

        .focus-btn, .delete-btn { 
            background: var(--background-color);
            border: 1px solid var(--border-color);
            cursor: pointer; 
            font-size: 22px; 
            color: var(--text-secondary-color); 
            transition: all 0.2s; 
            padding: 10px;
            border-radius: 10px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .focus-btn:active { 
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .delete-btn:active { 
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        /* ========== FOCUS OVERLAY ========== */
        #focus-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(10px); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            color: white; 
            z-index: 1000; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.4s ease, visibility 0.4s ease; 
            padding: 20px;
        }

        #focus-overlay.visible { 
            opacity: 1; 
            visibility: visible; 
        }

        #focus-label { 
            font-size: 16px; 
            color: #94a3b8; 
            margin-bottom: 12px; 
            font-weight: 500;
        }

        #focus-task-name { 
            font-size: 26px; 
            font-weight: 700; 
            text-align: center; 
            margin-bottom: 40px; 
            max-width: 90%; 
            line-height: 1.4;
        }

        #focus-timer { 
            font-size: 80px; 
            font-weight: 700; 
            margin-bottom: 50px; 
            letter-spacing: 3px;
            font-variant-numeric: tabular-nums;
        }

        #stop-focus-btn { 
            padding: 18px 40px; 
            border: 2px solid white; 
            background: transparent; 
            color: white; 
            border-radius: 14px; 
            cursor: pointer; 
            font-size: 18px; 
            font-weight: 600; 
            font-family: 'Kanit', sans-serif;
            transition: all 0.2s; 
            min-height: 60px;
        }

        #stop-focus-btn:active { 
            background: white; 
            color: black; 
        }

        /* ========== NOTIFICATION BANNER ========== */
        #notification-banner { 
            background-color: var(--card-background); 
            padding: 18px; 
            margin-bottom: 20px; 
            border-radius: 14px; 
            border: 2px solid var(--primary-color); 
            display: none; 
            flex-direction: column;
            gap: 12px;
        }

        #notification-banner p { 
            margin: 0; 
            color: var(--text-color); 
            font-size: 15px;
            line-height: 1.5;
        }

        #enable-notifications-btn { 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 14px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-family: 'Kanit', sans-serif;
            font-size: 16px;
            font-weight: 600;
            min-height: 50px;
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary-color);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            line-height: 1.6;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 480px) {
            body {
                font-size: 16px;
            }

            header h1 {
                font-size: 20px;
            }

            .ai-task-name {
                font-size: 19px;
            }

            .ai-actions {
                grid-template-columns: 1fr;
            }

            .ai-btn.primary {
                order: -1;
            }

            #focus-timer {
                font-size: 64px;
            }

            #focus-task-name {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† AI Productivity Coach</h1>
            <div class="theme-switch-wrapper"> 
                <label class="theme-switch" for="theme-toggle"> 
                    <input type="checkbox" id="theme-toggle" /> 
                    <div class="slider round"></div> 
                </label> 
            </div>
        </header>

        <!-- AI Recommendation Card -->
        <div id="ai-recommendation-card">
            <div class="ai-header">
                <span class="ai-icon">ü§ñ</span>
                <span class="ai-label">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
            </div>
            <div class="ai-task-name" id="ai-task-name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>
            <div class="ai-reason" id="ai-reason">‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div>
            <div class="ai-actions">
                <button class="ai-btn primary" id="ai-do-now">
                    <span class="ai-btn-icon">‚ö°</span>
                    <span class="ai-btn-text">‡∏ó‡∏≥‡πÄ‡∏•‡∏¢</span>
                </button>
                <button class="ai-btn" id="ai-done">
                    <span class="ai-btn-icon">‚úÖ</span>
                    <span class="ai-btn-text">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>
                </button>
                <button class="ai-btn" id="ai-skip">
                    <span class="ai-btn-icon">‚è≠Ô∏è</span>
                    <span class="ai-btn-text">‡∏Ç‡πâ‡∏≤‡∏°</span>
                </button>
            </div>
        </div>

        <div id="notification-banner"> 
            <p>üîî ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏•‡∏≤‡∏î‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p> 
            <button id="enable-notifications-btn">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button> 
        </div>

        <div class="input-area"> 
            <input type="text" id="task-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå'"> 
            <button id="add-task-btn">‡πÄ‡∏û‡∏¥‡πà‡∏°</button> 
        </div>

        <div class="controls"> 
            <div class="filters"> 
                <button class="active" data-filter="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button> 
                <button data-filter="active">‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</button> 
                <button data-filter="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button> 
            </div> 
            <button id="clear-completed-btn">‡∏•‡πâ‡∏≤‡∏á</button> 
        </div>

        <ul id="task-list"></ul>
    </div>

    <div id="focus-overlay">
        <div id="focus-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Å‡∏±‡∏ö...</div> 
        <h2 id="focus-task-name">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</h2> 
        <div id="focus-timer">25:00</div> 
        <button id="stop-focus-btn">‡∏´‡∏¢‡∏∏‡∏î‡πÇ‡∏ü‡∏Å‡∏±‡∏™</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // ===== FIREBASE CONFIG (‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) =====
        const firebaseConfig = {
			apiKey: "AIzaSyANkkp8y0BiJlj5YscdRP7MxrsldAn5ei0",
			authDomain: "my-ultimate-todo.firebaseapp.com",
			projectId: "my-ultimate-todo",
			storageBucket: "my-ultimate-todo.firebasestorage.app",
			messagingSenderId: "333436474367",
			appId: "1:333436474367:web:d17d050e13ef503f5d0dca",
			measurementId: "G-HZM1HQMWRX"
		};
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tasksCollection = db.collection('tasks');

        document.addEventListener('DOMContentLoaded', () => {
            // ===== DOM ELEMENTS =====
            const taskInput = document.getElementById('task-input');
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskList = document.getElementById('task-list');
            const filterBtns = document.querySelectorAll('.filters button');
            const clearCompletedBtn = document.getElementById('clear-completed-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const focusOverlay = document.getElementById('focus-overlay');
            const focusTaskName = document.getElementById('focus-task-name');
            const focusTimerDisplay = document.getElementById('focus-timer');
            const stopFocusBtn = document.getElementById('stop-focus-btn');
            const notificationBanner = document.getElementById('notification-banner');
            const enableNotificationsBtn = document.getElementById('enable-notifications-btn');
            
            // AI Elements
            const aiCard = document.getElementById('ai-recommendation-card');
            const aiTaskName = document.getElementById('ai-task-name');
            const aiReason = document.getElementById('ai-reason');
            const aiDoNowBtn = document.getElementById('ai-do-now');
            const aiDoneBtn = document.getElementById('ai-done');
            const aiSkipBtn = document.getElementById('ai-skip');

            let timerInterval = null;
            let currentFilter = 'all';
            let allTasks = [];
            let currentRecommendation = null;
            let skippedTaskIds = new Set();

            // ===== SMART DATE PARSING =====
            const parseDueDate = (text) => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const daysOfWeek = { 
                    '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå': 0, '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå': 1, '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£': 2, '‡∏û‡∏∏‡∏ò': 3, 
                    '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ': 4, '‡∏û‡∏§‡∏´‡∏±‡∏™': 4, '‡∏®‡∏∏‡∏Å‡∏£‡πå': 5, '‡πÄ‡∏™‡∏≤‡∏£‡πå': 6 
                };

                if (text.includes('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ')) return today;
                if (text.includes('‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ')) return new Date(today.getTime() + 86400000);
                if (text.includes('‡∏°‡∏∞‡∏£‡∏∑‡∏ô')) return new Date(today.getTime() + 2 * 86400000);
                
                for (const day in daysOfWeek) {
                    if (text.includes(day)) {
                        let targetDay = daysOfWeek[day];
                        let currentDay = now.getDay();
                        let dayDifference = targetDay - currentDay;
                        if (dayDifference <= 0) dayDifference += 7;
                        return new Date(today.getTime() + dayDifference * 86400000);
                    }
                }

                const dateMatch = text.match(/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà\s*(\d+)/);
                if (dateMatch && dateMatch[1]) {
                    const dayOfMonth = parseInt(dateMatch[1]);
                    if (dayOfMonth >= now.getDate()) {
                        return new Date(now.getFullYear(), now.getMonth(), dayOfMonth);
                    } else {
                        return new Date(now.getFullYear(), now.getMonth() + 1, dayOfMonth);
                    }
                }
                return null;
            };
            
            const getCountdownText = (dueDate) => {
                if (!dueDate) return null;
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now
				                .getDate());
                const due = new Date(dueDate);
                const diffDays = Math.round((due - today) / 86400000);

                if (diffDays < 0) return null;
                if (diffDays === 0) return '(‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
                if (diffDays === 1) return '(‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ)';
                return `(‡∏≠‡∏µ‡∏Å ${diffDays} ‡∏ß‡∏±‡∏ô)`;
            };

            // ===== HELPER FUNCTIONS =====
            const getPriority = (text) => { 
                const keywords = ['‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', '‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å', '‡∏î‡πà‡∏ß‡∏ô', 'urgent', 'asap', 
                                '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à', '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å', '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', '‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ'];
                return keywords.some(k => text.toLowerCase().includes(k)); 
            };

            const getMoodCharacter = (task) => {
                const isDueToday = task.dueDate && getCountdownText(task.dueDate) === '(‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
                if (task.done) return '‚úÖ';
                if (task.isHighPriority || isDueToday) return 'üî•';
                const daysOld = Math.round((Date.now() - task.createdAt) / 86400000);
                if (daysOld >= 3) return 'üò¥';
                return 'üí°';
            };

            const getCharacterAnimationClass = (task) => {
                const isDueToday = task.dueDate && getCountdownText(task.dueDate) === '(‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
                if (task.done) return '';
                if (task.isHighPriority || isDueToday) return 'excited';
                const daysOld = Math.round((Date.now() - task.createdAt) / 86400000);
                if (daysOld >= 3) return 'sleepy';
                return '';
            };

            // ===== AI RECOMMENDATION ENGINE =====
            const calculateTaskScore = (task) => {
                if (task.done) return -1;
                if (skippedTaskIds.has(task.id)) return -1;

                let score = 50;
                const now = Date.now();
                const daysOld = (now - task.createdAt) / 86400000;

                // Priority weight
                if (task.isHighPriority) score += 40;

                // Deadline weight
                if (task.dueDate) {
                    const daysUntilDue = (task.dueDate - now) / 86400000;
                    if (daysUntilDue <= 0) score += 100; // Overdue
                    else if (daysUntilDue <= 1) score += 60; // Due today/tomorrow
                    else if (daysUntilDue <= 3) score += 30;
                    else score += 10;
                }

                // Age weight (‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥)
                if (daysOld >= 7) score += 35;
                else if (daysOld >= 3) score += 20;
                else if (daysOld >= 1) score += 10;

                // Task complexity (‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ó‡∏≥‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤ - Quick wins!)
                const textLength = task.text.length;
                if (textLength < 30) score += 15; // ‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡∏ó‡∏≥‡∏á‡πà‡∏≤‡∏¢
                else if (textLength < 50) score += 5;

                return score;
            };

            const getRecommendationReason = (task) => {
                const reasons = [];
                const now = Date.now();
                const daysOld = (now - task.createdAt) / 86400000;

                if (task.isHighPriority) {
                    reasons.push('üìå ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á');
                }

                if (task.dueDate) {
                    const daysUntilDue = (task.dueDate - now) / 86400000;
                    if (daysUntilDue <= 0) reasons.push('‚è∞ ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß!');
                    else if (daysUntilDue <= 1) reasons.push('‚è∞ ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ');
                }

                if (daysOld >= 7) {
                    reasons.push(`‚åõ ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ${Math.floor(daysOld)} ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
                } else if (daysOld >= 3) {
                    reasons.push(`‚åõ ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß`);
                }

                if (task.text.length < 30) {
                    reasons.push('‚ö° ‡∏á‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß');
                }

                if (reasons.length === 0) {
                    reasons.push('üí™ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô');
                }

                return reasons.join(' ‚Ä¢ ');
            };

            const updateAIRecommendation = () => {
                const activeTasks = allTasks.filter(t => !t.done);
                
                if (activeTasks.length === 0) {
                    aiCard.classList.remove('visible');
                    currentRecommendation = null;
                    return;
                }

                // Calculate scores
                const scoredTasks = activeTasks.map(task => ({
                    task,
                    score: calculateTaskScore(task)
                })).filter(item => item.score >= 0);

                if (scoredTasks.length === 0) {
                    // All tasks skipped - reset
                    skippedTaskIds.clear();
                    updateAIRecommendation();
                    return;
                }

                // Get highest score
                scoredTasks.sort((a, b) => b.score - a.score);
                const recommended = scoredTasks[0].task;

                currentRecommendation = recommended;
                aiTaskName.textContent = recommended.text;
                aiReason.textContent = getRecommendationReason(recommended);
                aiCard.classList.add('visible');
            };

            // ===== RENDERING FUNCTIONS =====
            const renderTasks = () => {
                const filteredTasks = allTasks.filter(task => { 
                    if (currentFilter === 'active') return !task.done; 
                    if (currentFilter === 'completed') return task.done; 
                    return true; 
                });

                taskList.innerHTML = '';

                if (filteredTasks.length === 0) { 
                    const emptyState = document.createElement('li');
                    emptyState.className = 'empty-state';
                    emptyState.innerHTML = `
                        <div class="empty-state-icon">
                            ${currentFilter === 'completed' ? 'üéâ' : '‚ú®'}
                        </div>
                        <div class="empty-state-text">
                            ${currentFilter === 'completed' 
                                ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à' 
                                : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!'}
                        </div>
                    `;
                    taskList.appendChild(emptyState);
                } else { 
                    filteredTasks.forEach(renderTaskItem); 
                }

                const hasCompleted = allTasks.some(task => task.done);
                clearCompletedBtn.classList.toggle('visible', hasCompleted);

                updateAIRecommendation();
            };

            const renderTaskItem = (task) => {
                const isDueToday = task.dueDate && getCountdownText(task.dueDate) === '(‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)';
                const li = document.createElement('li');
                li.className = 'task-item';
                li.dataset.id = task.id;
                if (task.done) li.classList.add('done');

                const moodCharacterSpan = document.createElement('span');
                moodCharacterSpan.className = `mood-character ${getCharacterAnimationClass(task)}`;
                moodCharacterSpan.textContent = getMoodCharacter(task);

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.done;
                checkbox.addEventListener('change', () => toggleTask(task.id, task.done));

                const contentDiv = document.createElement('div');
                contentDiv.className = 'task-content';

                const textSpan = document.createElement('span');
                textSpan.className = 'task-text';
                textSpan.textContent = task.text;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'task-details';

                const timeStampDiv = document.createElement('div');
                timeStampDiv.className = 'task-timestamp';
                timeStampDiv.textContent = new Date(task.createdAt).toLocaleString('th-TH', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                detailsDiv.appendChild(timeStampDiv);

                const countdownText = getCountdownText(task.dueDate);
                if (countdownText) {
                    const countdownSpan = document.createElement('span');
                    countdownSpan.className = 'task-countdown';
                    countdownSpan.textContent = countdownText;
                    detailsDiv.appendChild(countdownSpan);
                }

                if (task.isHighPriority || isDueToday) {
                    const tag = document.createElement('span');
                    tag.className = 'priority-tag';
                    tag.textContent = 'üí• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç';
                    detailsDiv.appendChild(tag);
                }

                contentDiv.appendChild(textSpan);
                contentDiv.appendChild(detailsDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'task-actions';

                if (!task.done) {
                    const focusBtn = document.createElement('button');
                    focusBtn.className = 'focus-btn';
                    focusBtn.innerHTML = '‚ñ∂Ô∏è';
                    focusBtn.title = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏ü‡∏Å‡∏±‡∏™';
                    focusBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startFocusMode(task);
                    });
                    actionsDiv.appendChild(focusBtn);
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.title = '‡∏•‡∏ö';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTask(task.id);
                });
                actionsDiv.appendChild(deleteBtn);

                li.appendChild(moodCharacterSpan);
                li.appendChild(checkbox);
                li.appendChild(contentDiv);
                li.appendChild(actionsDiv);
                taskList.appendChild(li);
            };

            // ===== FIRESTORE FUNCTIONS =====
            const addTask = () => {
                const taskText = taskInput.value.trim();
                if (taskText === '') return;

                const dueDate = parseDueDate(taskText);
                
                tasksCollection.add({
                    text: taskText,
                    done: false,
                    isHighPriority: getPriority(taskText),
                    createdAt: Date.now(),
                    dueDate: dueDate ? dueDate.getTime() : null
                });

                taskInput.value = '';
                taskInput.focus();
            };

            const toggleTask = (id, currentStatus) => {
                tasksCollection.doc(id).update({ done: !currentStatus });
                if (!currentStatus && currentRecommendation && currentRecommendation.id === id) {
                    skippedTaskIds.delete(id);
                    setTimeout(updateAIRecommendation, 300);
                }
            };

            const deleteTask = (id) => {
                if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    tasksCollection.doc(id).delete();
                    if (currentRecommendation && currentRecommendation.id === id) {
                        skippedTaskIds.delete(id);
                    }
                }
            };

            // ===== REAL-TIME LISTENER =====
            tasksCollection.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                allTasks = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { id: doc.id, ...data };
                });
                renderTasks();
            });

            // ===== AI BUTTON ACTIONS =====
            aiDoNowBtn.addEventListener('click', () => {
                if (currentRecommendation) {
                    startFocusMode(currentRecommendation);
                }
            });

            aiDoneBtn.addEventListener('click', () => {
                if (currentRecommendation) {
                    toggleTask(currentRecommendation.id, false);
                }
            });

            aiSkipBtn.addEventListener('click', () => {
                if (currentRecommendation) {
                    skippedTaskIds.add(currentRecommendation.id);
                    updateAIRecommendation();
                }
            });

            // ===== EVENT LISTENERS =====
            addTaskBtn.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', e => e.key === 'Enter' && addTask());

            filterBtns.forEach(button => {
                button.addEventListener('click', () => {
                    filterBtns.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentFilter = button.dataset.filter;
                    renderTasks();
                });
            });

            clearCompletedBtn.addEventListener('click', () => {
                if (confirm('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                    allTasks.filter(t => t.done).forEach(t => tasksCollection.doc(t.id).delete());
                }
            });

            // ===== FOCUS MODE =====
            let focusedTask = null;

            const startFocusMode = (task) => {
                if (task.done) return;
                
                focusedTask = task;
                document.body.classList.add('in-focus-mode');
                focusOverlay.classList.add('visible');
                focusTaskName.textContent = task.text;

                let duration = 25 * 60;
                clearInterval(timerInterval);

                const updateTimer = () => {
                    const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
                    const seconds = (duration % 60).toString().padStart(2, '0');
                    focusTimerDisplay.textContent = `${minutes}:${seconds}`;
                    document.title = `${minutes}:${seconds} - ${task.text}`;

                    if (--duration < 0) {
                        clearInterval(timerInterval);
                        document.title = "üß† AI Productivity Coach";
                        
                        if (confirm(`üéâ ‡∏Ñ‡∏£‡∏ö 25 ‡∏ô‡∏≤‡∏ó‡∏µ!\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏£‡πå‡∏Å‡∏á‡∏≤‡∏ô "${task.text}" ‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                            toggleTask(focusedTask.id, false);
                        }
                        stopFocusMode();
                    }
                };

                updateTimer();
                timerInterval = setInterval(updateTimer, 1000);
            };

            const stopFocusMode = () => {
                clearInterval(timerInterval);
                document.body.classList.remove('in-focus-mode');
                focusOverlay.classList.remove('visible');
                document.title = "üß† AI Productivity Coach";
                focusedTask = null;
            };

            stopFocusBtn.addEventListener('click', stopFocusMode);

            // ===== THEME TOGGLE =====
            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('aiCoachTheme', theme);
                themeToggle.checked = theme === 'dark';
            };

            themeToggle.addEventListener('change', () => {
                applyTheme(themeToggle.checked ? 'dark' : 'light');
            });

            const savedTheme = localStorage.getItem('aiCoachTheme') || 'light';
            applyTheme(savedTheme);

            // ===== NOTIFICATIONS =====
            const setupNotifications = () => {
                if (!("Notification" in window)) return;

                if (Notification.permission === "granted") {
                    setInterval(checkNotifications, 3600000); // Every hour
                } else if (Notification.permission !== "denied") {
                    notificationBanner.style.display = 'flex';
                }
            };

            const checkNotifications = () => {
                const pending = allTasks.filter(t => !t.done);
                if (pending.length > 0) {
                    const urgentTask = pending.find(t => t.isHighPriority) || pending[0];
                    const body = `‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ ${pending.length} ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à${urgentTask.isHighPriority ? ' ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' : ''}: "${urgentTask.text}"`;
                    
                    new Notification('‚è∞ ‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞!', {
                        body,
                        icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>",
                        badge: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîî</text></svg>"
                    });
                }
            };

            enableNotificationsBtn.addEventListener('click', () => {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationBanner.style.display = 'none';
                        setInterval(checkNotifications, 3600000);
                        
                        new Notification('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß!', {
                            body: '‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà',
                            icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß†</text></svg>"
                        });
                    }
                });
            });

            setupNotifications();

            // Initial focus
            taskInput.focus();
        });
    </script>
</body>
</html>
